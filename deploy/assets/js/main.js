!function($){var EventDispatcher=include("cloudkid.EventDispatcher"),EditorInterface=function(a){EventDispatcher.call(this),this.spawnTypes=a;for(var b=["alphaStart","alphaEnd","scaleStart","scaleEnd","colorStart","colorEnd","speedStart","speedEnd","startRotationMin","startRotationMax","rotationSpeedMin","rotationSpeedMax","lifeMin","lifeMax","blendMode","customEase","emitFrequency","emitLifetime","emitMaxParticles","emitSpawnPosX","emitSpawnPosY","emitAddAtBack","emitSpawnType","emitRectX","emitRectY","emitRectW","emitRectH","emitCircleX","emitCircleY","emitCircleR","emitParticlesPerWave","emitParticleSpacing","emitAngleStart","defaultConfigSelector","defaultImageSelector","configUpload","configPaste","imageUpload","imageDialog","imageList","refresh","loadConfig","downloadConfig","configDialog","addImage","stageColor","content","renderer"],c=0;c<b.length;c++)this[b[c]]=$("#"+b[c]);this.downloadConfig.click(this.download.bind(this)),this.init()},p=EditorInterface.prototype=Object.create(EventDispatcher.prototype);p.changed=function(){this.trigger("change")},p.init=function(){var a=this,b=(cloudkid.Application.instance,this.changed.bind(this));this.refresh.button({icons:{primary:"ui-icon-arrowrefresh-1-s"}}),this.loadConfig.button({icons:{primary:"ui-icon-folder-open"}}),this.downloadConfig.button({icons:{primary:"ui-icon-arrowthickstop-1-s"}}),$(".unitSlider").slider({animate:"fast",min:0,max:1,step:.01}).on("slidechange slidestop",b);var c=$(".slider");c.on("slide slidechange",function(a,b){$(this).children("input").val(b.value)}).on("slidechange slidestop",b),$(".slider input").change(function(){$(this).parent().slider("value",$(this).val().replace(/[^0-9.]+/,"")),b()}),$(".positiveSpinner").spinner({min:0,numberFormat:"n",step:.01}).on("spinchange spinstop",b),$(".frequencySpinner").spinner({min:0,numberFormat:"n",step:.001}).on("spinchange spinstop",b),$(".generalSpinner").spinner({numberFormat:"n",step:.1}).on("spinchange spinstop",b),$(".posIntSpinner").spinner({min:1,step:1}).on("spinchange spinstop",b),$(".colorPicker").colorpicker({parts:["header","map","bar","hsv","rgb","hex","preview","footer"],showOn:"both",buttonColorize:!0,okOnEnter:!0,revert:!0,mode:"h",buttonImage:"assets/js/colorpicker/images/ui-colorpicker.png",select:b}),this.renderer.buttonset().find("input").change(function(){a.trigger("renderer",this.value),b()}),this.blendMode.selectmenu().on("selectmenuchange",b),this.customEase.on("input",b),this.addImage.button().click(function(b){a.defaultImageSelector.find("option:contains('-Default Images-')").prop("selected",!0),a.defaultImageSelector.selectmenu("refresh"),a.imageUpload.wrap("<form>").parent("form").trigger("reset"),a.imageUpload.unwrap(),a.imageDialog.dialog("open"),b.preventDefault()}),this.imageDialog.dialog({autoOpen:!1,width:400,buttons:[{text:"Cancel",click:function(){$(this).dialog("close")}}]}),this.defaultImageSelector.selectmenu(),this.loadConfig.click(function(b){a.defaultConfigSelector.find("option:contains('-Default Emitters-')").prop("selected",!0),a.defaultConfigSelector.selectmenu("refresh"),a.configUpload.wrap("<form>").parent("form").trigger("reset"),a.configUpload.unwrap(),a.configPaste.val(""),a.configDialog.dialog("open"),b.preventDefault()}),this.configDialog.dialog({autoOpen:!1,width:400,buttons:[{text:"Cancel",click:function(){$(this).dialog("close")}}]}),this.defaultConfigSelector.selectmenu();var d=this.spawnTypes;this.emitSpawnType.selectmenu({select:function(){for(var b=a.emitSpawnType.val(),c=0;c<d.length;++c)d[c]==b?$(".settings-"+d[c]).show():$(".settings-"+d[c]).hide()}}).on("selectmenuchange",b),this.stageColor.colorpicker({select:function(b,c){a.trigger("stageColor",c.formatted)}})},p.set=function(a){this.alphaStart.slider("value",a.alpha?a.alpha.start:1),this.alphaEnd.slider("value",a.alpha?a.alpha.end:1),this.scaleStart.spinner("value",a.scale?a.scale.start:1),this.scaleEnd.spinner("value",a.scale?a.scale.end:1),this.colorStart.colorpicker("setColor",a.color?a.color.start:"FFFFFF"),this.colorEnd.colorpicker("setColor",a.color?a.color.end:"FFFFFF"),this.speedStart.spinner("value",a.speed?a.speed.start:0),this.speedEnd.spinner("value",a.speed?a.speed.end:0),this.startRotationMin.spinner("value",a.startRotation?a.startRotation.min:0),this.startRotationMax.spinner("value",a.startRotation?a.startRotation.max:0),this.rotationSpeedMin.spinner("value",a.rotationSpeed?a.rotationSpeed.min:0),this.rotationSpeedMax.spinner("value",a.rotationSpeed?a.rotationSpeed.max:0),this.lifeMin.spinner("value",a.lifetime?a.lifetime.min:1),this.lifeMax.spinner("value",a.lifetime?a.lifetime.max:1),this.customEase.val(a.ease?JSON.stringify(a.ease):"");var b;if(a.blendMode&&cloudkid.ParticleUtils.getBlendMode(a.blendMode))for(b=a.blendMode.toLowerCase();b.indexOf(" ")>=0;)b=b.replace("_");else b="normal";this.blendMode.find("option[value='"+b+"']").prop("selected",!0),this.blendMode.selectmenu("refresh"),this.emitFrequency.spinner("value",parseFloat(a.frequency)>0?parseFloat(a.frequency):.5),this.emitLifetime.spinner("value",a.emitterLifetime||-1),this.emitMaxParticles.spinner("value",a.maxParticles||1e3),this.emitSpawnPosX.spinner("value",a.pos?a.pos.x:0),this.emitSpawnPosY.spinner("value",a.pos?a.pos.y:0),this.emitAddAtBack.prop("checked",!!a.addAtBack);var c=a.spawnType,d=this.spawnTypes;-1==d.indexOf(c)&&(c=d[0]),this.emitSpawnType.val(c),this.emitSpawnType.selectmenu("refresh");for(var e=0;e<d.length;++e)d[e]==c?$(".settings-"+d[e]).show():$(".settings-"+d[e]).hide();this.emitRectX.spinner("value",a.spawnRect?a.spawnRect.x:0),this.emitRectY.spinner("value",a.spawnRect?a.spawnRect.y:0),this.emitRectW.spinner("value",a.spawnRect?a.spawnRect.w:0),this.emitRectH.spinner("value",a.spawnRect?a.spawnRect.h:0),this.emitCircleX.spinner("value",a.spawnCircle?a.spawnCircle.x:0),this.emitCircleY.spinner("value",a.spawnCircle?a.spawnCircle.y:0),this.emitCircleR.spinner("value",a.spawnCircle?a.spawnCircle.r:0),this.emitParticlesPerWave.spinner("value",a.particlesPerWave>0?a.particlesPerWave:1),this.emitParticleSpacing.spinner("value",a.particleSpacing?a.particleSpacing:0),this.emitAngleStart.spinner("value",a.angleStart?a.angleStart:0)},p.get=function(){var output={};output.alpha={start:this.alphaStart.slider("value"),end:this.alphaEnd.slider("value")},output.scale={start:this.scaleStart.spinner("value"),end:this.scaleEnd.spinner("value")},output.color={start:this.colorStart.val(),end:this.colorEnd.val()},output.speed={start:this.speedStart.spinner("value"),end:this.speedEnd.spinner("value")},output.startRotation={min:this.startRotationMin.spinner("value"),max:this.startRotationMax.spinner("value")},output.rotationSpeed={min:this.rotationSpeedMin.spinner("value"),max:this.rotationSpeedMax.spinner("value")},output.lifetime={min:this.lifeMin.spinner("value"),max:this.lifeMax.spinner("value")},output.blendMode=this.blendMode.val();var val=this.customEase.val();if(val)try{eval("val = "+val+";"),val&&"string"!=typeof val&&(output.ease=val)}catch(e){Debug.error("Error evaluating easing data: "+e.message)}var frequency=this.emitFrequency.spinner("value");output.frequency=parseFloat(frequency)>0?parseFloat(frequency):.5,output.emitterLifetime=this.emitLifetime.spinner("value"),output.maxParticles=this.emitMaxParticles.spinner("value"),output.pos={x:this.emitSpawnPosX.spinner("value"),y:this.emitSpawnPosY.spinner("value")},output.addAtBack=this.emitAddAtBack.prop("checked");var spawnType=output.spawnType=this.emitSpawnType.val();return"rect"==spawnType?output.spawnRect={x:this.emitRectX.spinner("value"),y:this.emitRectY.spinner("value"),w:this.emitRectW.spinner("value"),h:this.emitRectH.spinner("value")}:"circle"==spawnType?output.spawnCircle={x:this.emitCircleX.spinner("value"),y:this.emitCircleY.spinner("value"),r:this.emitCircleR.spinner("value")}:"burst"==spawnType&&(output.particlesPerWave=this.emitParticlesPerWave.spinner("value"),output.particleSpacing=this.emitParticleSpacing.spinner("value"),output.angleStart=this.emitAngleStart.spinner("value")),output},p.download=function(){var a=JSON.stringify(this.get(),null,"	"),b="data:application/json;charset=utf-8",c=!1;try{c=!!new Blob}catch(d){}c?window.saveAs(new Blob([a],{type:b}),"emitter.json"):window.open(encodeURI(b+","+a))},namespace("cloudkid").EditorInterface=EditorInterface}(jQuery),function(){var Texture=include("PIXI.Texture"),Sprite=include("PIXI.Sprite"),Point=include("PIXI.Point"),Graphics=include("PIXI.Graphics"),PixiTask=include("cloudkid.PixiTask"),LoadTask=include("cloudkid.LoadTask"),PixiDisplay=include("cloudkid.PixiDisplay"),TaskManager=include("cloudkid.TaskManager"),Emitter=include("cloudkid.Emitter"),Application=include("cloudkid.Application"),Loader=include("cloudkid.Loader"),SavedData=include("cloudkid.SavedData"),EditorInterface=include("cloudkid.EditorInterface"),Editor=function(a){Application.call(this,a)},p=Editor.prototype=Object.create(Application.prototype),stage,backgroundSprite,emitter,emitterContainer,emitterEnableTimer=0,particleDefaults={},particleDefaultImages={},particleDefaultImageUrls={},jqImageDiv=null,particleCountDiv=null;p.init=function(){this.onMouseIn=this.onMouseIn.bind(this),this.onMouseOut=this.onMouseOut.bind(this),this.onMouseMove=this.onMouseMove.bind(this),this.onMouseUp=this.onMouseUp.bind(this),this.onTexturesLoaded=this.onTexturesLoaded.bind(this),this.loadFromUI=this.loadFromUI.bind(this),jqImageDiv=$(".particleImage"),jqImageDiv.remove(),particleCountDiv=document.getElementById("particleCount");var a=parseInt(SavedData.read("stageColor")||"999999",16);backgroundSprite=new PIXI.Sprite(PIXI.Texture.fromImage("assets/images/bg.png")),backgroundSprite.tint=a,emitterContainer=new PIXI.DisplayObjectContainer;var b={clearView:!0,backgroundColor:a,forceContext:"webgl"};this.webgl=this.addDisplay("webgl",PixiDisplay,b),b.forceContext="canvas2d",this.canvas2d=this.addDisplay("canvas2d",PixiDisplay,b),this.setRenderer("webgl"),Loader.instance.load("assets/config/config.json",this.onInitialized.bind(this)),backgroundSprite.scale.x=this.webgl.width,backgroundSprite.scale.y=this.webgl.height,this.on("resize",this.onResize)},p.onResize=function(a,b){backgroundSprite.scale.x=a,backgroundSprite.scale.y=b},p.onInitialized=function(a){$("body").removeClass("loading"),this.config=a.content,this.ui=new EditorInterface(this.config.spawnTypes),this.ui.refresh.click(this.loadFromUI),this.ui.defaultImageSelector.on("selectmenuselect",this.loadImage.bind(this,"select")),this.ui.imageUpload.change(this.loadImage.bind(this,"upload")),this.ui.defaultConfigSelector.on("selectmenuselect",this.loadConfig.bind(this,"default")),this.ui.configUpload.change(this.loadConfig.bind(this,"upload")),this.ui.configPaste.on("paste",this.loadConfig.bind(this,"paste")),this.ui.stageColor.colorpicker("setColor",SavedData.read("stageColor")||"999999"),this.ui.on({change:this.loadFromUI,renderer:this.setRenderer.bind(this),stageColor:this.stageColor.bind(this)});for(var b,c=[],d=[],e=0;e<this.config.emitters.length;e++)b=this.config.emitters[e],c.push(new LoadTask(b.id,b.config,this.onConfigLoaded));for(var f in this.config.images)d.push(this.config.images[f]);var g;try{g=SavedData.read("customImages")}catch(h){}if(g)for(e=0;e<g.length;e++)-1==d.indexOf(g[e])&&d.push(g[e]);c.push(new PixiTask("particle",d,this.onTexturesLoaded)),TaskManager.process(c,this._onCompletedLoad.bind(this))},p.onConfigLoaded=function(a,b){particleDefaults[b.id]=a.content},p.onTexturesLoaded=function(){for(var a,b,c,d=this.config.images,e=0;e<this.config.emitters.length;e++){a=this.config.emitters[e],c=a.id,particleDefaultImageUrls[c]=[],particleDefaultImages[c]=[];for(var f=0;f<a.images.length;f++)b=a.images[f],particleDefaultImageUrls[c].push(d[b]),particleDefaultImages[c].push(Texture.fromImage(b))}},p._onCompletedLoad=function(){emitter=new Emitter(emitterContainer);var a,b,c=window.location.hash.replace("#","");try{a=SavedData.read("customConfig"),b=SavedData.read("customImages")}catch(d){}if(c)this.loadDefault(c);else if(a&&b){this.loadSettings(getTexturesFromUrls(b),a),this.setConfig(a);for(var e=0;e<b.length;++e)this.addImage(b[e])}else this.loadDefault(this.config.default);this.on({resize:this._centerEmitter.bind(this),update:this.update.bind(this)})},p.stageColor=function(a){SavedData.write("stageColor",a),backgroundSprite.tint=parseInt(a,16)},p.setRenderer=function(a){var b="webgl"==a?this.canvas2d:this.webgl;b.enabled=b.visible=!1;var c=this[a];stage&&(stage.mousemove=null),stage=c.stage,stage.interactionManager.stageIn=this.onMouseIn,stage.interactionManager.stageOut=this.onMouseOut,stage.mouseup=this.onMouseUp,c.enabled=c.visible=!0,backgroundSprite&&stage.addChild(backgroundSprite),emitterContainer&&stage.addChild(emitterContainer)},p.loadDefault=function(a){a&&particleDefaultImageUrls[a]||(a=trail),window.location.hash="#"+a,this.ui.imageList.children().remove();var b=particleDefaultImageUrls[a];SavedData.write("customImages",b);for(var c=0;c<b.length;++c)this.addImage(b[c]);this.loadSettings(particleDefaultImages[a],particleDefaults[a]),this.setConfig(particleDefaults[a])},p.setConfig=function(a){this.ui.off("change"),this.ui.set(a),this.ui.on("change",this.loadFromUI)};var getTexturesFromUrls=function(a){for(var b=[],c=0;c<a.length;++c)b[c]=Texture.fromImage(a[c]);return b};p.loadConfig=function(type,event){var ui=this.ui;if("default"==type){var value=ui.defaultConfigSelector.val();if("-Default Emitters-"==value)return;this.loadDefault(value),ui.configDialog.dialog("close")}else if("paste"==type){var elem=ui.configPaste;setTimeout(function(){try{eval("var obj = "+elem.val()+";"),this.setConfig(obj),this.loadFromUI()}catch(e){}ui.configDialog.dialog("close")}.bind(this),10)}else if("upload"==type){for(var files=event.originalEvent.target.files,scope=this,onloadend=function(readerObj){try{eval("var obj = "+readerObj.result+";"),scope.setConfig(obj),scope.loadFromUI()}catch(e){}},i=0;i<files.length;i++){var file=files[i],reader=new FileReader;reader.onloadend=onloadend.bind(this,reader),reader.readAsText(file)}ui.configDialog.dialog("close")}},p.loadImage=function(a,b){if("select"==a){var c=this.ui.defaultImageSelector.val();if("-Default Images-"==c)return;this.addImage(c),this.loadFromUI()}else if("upload"==a)for(var d=b.originalEvent.target.files,e=function(a){this.addImage(a.result),this.loadFromUI()},f=0;f<d.length;f++){var g=d[f],h=new FileReader;h.onloadend=e.bind(this,h),h.readAsDataURL(g)}this.ui.imageDialog.dialog("close")},p.addImage=function(a){PIXI.Texture.fromFrame(a,!0)||TaskManager.process([new PixiTask("image",[a],this.onTexturesLoaded)],function(){});var b=jqImageDiv.clone();b.children("img").prop("src",a),this.ui.imageList.append(b),b.children(".remove").button({icons:{primary:"ui-icon-close"},text:!1}).click(removeImage.bind(this)),b.children(".download").button({icons:{primary:"ui-icon-arrowthickstop-1-s"},text:!1}).click(downloadImage)};var downloadImage=function(a){var b=$(a.delegateTarget).siblings("img").prop("src");window.open(b)},removeImage=function(a){$(a.delegateTarget).parent().remove(),this.loadFromUI()};p.loadFromUI=function(){window.location.hash="";var a=this.ui.get(),b=this.getTexturesFromImageList();SavedData.write("customConfig",a),this.loadSettings(b,a)},p.getTexturesFromImageList=function(){var a=[],b=this.ui.imageList.find("img");if(0===b.length)return null;return b.each(function(){a.push(this.src)}),SavedData.write("customImages",a),getTexturesFromUrls(a)},p.loadSettings=function(a,b){emitter&&(emitter.init(a,b),this._centerEmitter(),emitterEnableTimer=0)},p.update=function(a){emitter&&(emitter.update(.001*a),!emitter.emit&&0>=emitterEnableTimer?emitterEnableTimer=1e3+1e3*emitter.maxLifetime:emitterEnableTimer>0&&(emitterEnableTimer-=a,0>=emitterEnableTimer&&(emitter.emit=!0)),particleCountDiv.innerHTML=emitter._activeParticles.length+" Particles")},p.onMouseUp=function(){emitter&&(emitter.resetPositionTracking(),emitter.emit=!0,emitterEnableTimer=0)},p.onMouseIn=function(){emitter&&(stage.mousemove=this.onMouseMove,emitter.resetPositionTracking())},p._centerEmitter=function(){emitter&&emitter.ownerPos&&emitter.updateOwnerPos(this.display.canvas.width/2,this.display.canvas.height/2)},p.onMouseOut=function(){emitter&&(stage.mousemove=null,this._centerEmitter(),emitter.resetPositionTracking())},p.onMouseMove=function(a){emitter&&emitter.updateOwnerPos(a.global.x,a.global.y)},namespace("cloudkid").Editor=Editor}(),function(){new cloudkid.Editor({framerate:"framerate",fps:60,raf:!0,debug:!1,resizeElement:"content",uniformResize:!1})}();